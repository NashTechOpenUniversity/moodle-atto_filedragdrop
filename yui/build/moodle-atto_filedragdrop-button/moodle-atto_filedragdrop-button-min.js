YUI.add("moodle-atto_filedragdrop-button",function(e,t){var n="atto_filedragdrop",r='<a href="{{url}}" {{#if id}}id="{{id}}" {{/if}}>{{text}}',i='<img src="{{url}}" {{#if alt}}alt="{{alt}}" {{/if}} style="vertical-align:text-bottom;margin: 0 .5em;" class="img-responsive" {{#if presentation}}role="presentation" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';e.namespace("M.atto_filedragdrop").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){var t=this,s=this.get("host"),o=e.Handlebars.compile(r),u=e.Handlebars.compile(i);this.editor.on("drop",function(r){console.log("File dragdrop handler running..."),s.saveSelection(),r=r._event;var i=r.dataTransfer&&r.dataTransfer.files&&r.dataTransfer.files.length;console.log("Handles data transfer: "+(i?"Yes":"No"));if(i&&!/^image\//.test(r.dataTransfer.files[0].type)){console.log("Not an image."),r.preventDefault(),r.stopPropagation();var a=s.get("filepickeroptions").image,f=a.savepath===undefined?"/":a.savepath,l=new FormData;l.append("repo_upload_file",r.dataTransfer.files[0]),l.append("itemid",a.itemid);var c=Object.keys(a.repositories);for(var h=0;h<c.length;h++)if(a.repositories[c[h]].type==="upload"){l.append("repo_id",a.repositories[c[h]].id);break}l.append("env",a.env),l.append("sesskey",M.cfg.sesskey),l.append("client_id",a.client_id),l.append("savepath",f),l.append("ctx_id",a.context.id);var p=(new Date).getTime(),d="moodlefile_"+Math.round(Math.random()*1e5)+"-"+p;s.focus(),s.restoreSelection();var v=u({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",n),id:d});s.insertContentAtFocusPoint(v),t.markUpdated();var m=new XMLHttpRequest;return m.onreadystatechange=function(){if(m.readyState===4){var n=t.editor.one("#"+d);if(m.status===200){var r=JSON.parse(m.responseText);if(r){if(r.error)return n&&n.remove(!0),new M.core.ajaxException(r);var i=r;r.event&&r.event==="fileexists"&&(i=r.newfile);var s=o({url:i.url,text:i.file}),u=e.Node.create(s);n?n.replace(u):t.editor.appendChild(u),t.markUpdated()}}else alert(M.util.get_string("servererror","moodle")),n&&n.remove(!0)}},m.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),m.send(l),!1}},this),console.log("File dragdrop initialised.")}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
