YUI.add("moodle-atto_imagedragdrop-button",function(e,t){M.atto_imagedragdrop=M.atto_imagedragdrop||{init:function(t){var n=this,r=M.editor_atto.get_editable_node(t.elementid);r.on("drop",function(n){M.editor_atto.save_selection(t),n=n._event;if(n.dataTransfer&&n.dataTransfer.files&&n.dataTransfer.files.length&&/^image\//.test(n.dataTransfer.files[0].type)){n.preventDefault(),n.stopPropagation();var r=M.editor_atto.filepickeroptions[t.elementid].image,i=new FormData;i.append("repo_upload_file",n.dataTransfer.files[0]),i.append("itemid",r.itemid);var s=0;for(;;){if(r.repositories[++s]===undefined)break;if(r.repositories[s].type==="upload"){i.append("repo_id",r.repositories[s].id);break}}i.append("env",r.env),i.append("sesskey",M.cfg.sesskey),i.append("client_id",r.client_id),i.append("savepath",r.savepath),i.append("ctx_id",r.context.id);var o=(new Date).getTime(),u="moodleimage_"+Math.round(Math.random()*1e5)+"-"+o,a={src:M.util.image_url("i/loading_small","moodle"),id:u,"class":"mceNonEditable"};M.editor_atto.focus(t.elementid),M.editor_atto.restore_selection(n,t.elementid),imagehtml='<img id="'+u+'" src="'+e.Escape.html(a.src)+'" alt="'+e.Escape.html("loading...")+'"/>',M.editor_atto.insert_html_at_focus_point(imagehtml),M.editor_atto.text_updated(t.elementid);var f=new XMLHttpRequest;return f.onreadystatechange=function(){if(f.readyState===4){var n=M.editor_atto.get_editable_node(t.elementid),r=n.one("#"+u);if(f.status===200){var i=JSON.parse(f.responseText);if(i){if(i.error)return r&&r.remove(!0),new M.core.ajaxException(i);var s=i;i.event&&i.event==="fileexists"&&(s=i.newfile);var o=s.filename||s.file,a='<img src="'+e.Escape.html(s.url)+'" alt="'+e.Escape.html(o)+'"/>',l=e.Node.create(a);r?r.replace(l):n.appendChild(l),M.editor_atto.text_updated(t.elementid)}}else alert(M.util.get_string("servererror","moodle")),r&&r.remove(!0)}},f.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),f.send(i),!1}},this)}}},"@VERSION@",{requires:["node","escape"]});
